Данная лабораторная работа продолжает повествование главы о [локализации проектов](https://github.com/UsamG1t/Methodics_of_LinuxAppDev/blob/master/Methodical_manual/08_I18n/8.%20%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F.md).

---

При разработке для определённой аудитории необходимо проводить интернационализацию и локализацию продукта. Подробнее о них описано в [главе](https://github.com/UsamG1t/Methodics_of_LinuxAppDev/blob/master/Methodical_manual/08_I18n/8.%20%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F.md#%D0%BE%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C-%D0%B2%D0%BB%D0%B8%D1%8F%D0%BD%D0%B8%D1%8F). Одной из основных задач локализации является перевод текстов с поддержкой множественных форм. Для этого в дистрибутивах семейства Альт используется пакет `glibs-locales`, хранящий основные библиотеки для работы с переводами и их поддержки.

Соберём пакет с поддержкой переводов.

`@user`: `sheepcounter-pkg/src/sheepcounter.c`

```c
#include <stdio.h>
#include <stdlib.h>
#include <libgen.h>
#include <libintl.h>
#include <locale.h>
#include "config.h"

#define _(STRING) gettext(STRING)
#define DATADIR "/usr/share/"
#define PKGNAME "sheepcounter"
#define INSTALL_PATH DATADIR PKGNAME
#define LOCALE_PATH "."

int main(int argc, char *argv[])
{
       int count;

       setlocale (LC_ALL, "");
       bindtextdomain ("sheepcounter", INSTALL_PATH);
       // bindtextdomain ("sheepcounter", LOCALE_PATH);
       textdomain ("sheepcounter");

       /* Simple text */
       puts(_("Let\'s count sheeps together!\n"));
       puts(_("How many sheeps do you want to count? "));

       scanf("%d", &count);

#ifndef NUMBERS
       while (count >= 10) {
               puts(_("Oh, I know only digits, not numbers, try again: "));
               scanf("%d", &count);
       }
#endif

       for(int i = 1; i <= count; i++)
               /* Plural example */
               printf(ngettext("We counted %d sheep\n", "We counted %d sheeps\n", i), i);

       return 0;
}
```

Для работы с переводами используется специальный набор инструментов [GNU gettext](https://www.gnu.org/software/gettext/). С помощью специальных функций-обёрток `gettext` и `ngettext` из библиотеки `locale.h` обозначаются элементы, которые необходимо будет локализовать. Для элементов, в которых возможна множественная форма, указывается также параметр, от которой она будет зависеть.

Для работы с переводами также необходимо завести _домен_ — отдельное множество переведённых строк, изолированное от других переводов _в ту же локаль_. Путь к домену указывается с помощью специальной функции.

P.S. Путь в `bindtextdomain` описывает место в файловой системе, где `gettext` будет при исполнении программы искать файлы с переводом (при этом файлы лежат в поддиректориях формата «<Язык перевода>/<Параметр локали>/<Файл перевода>»). `INSTALL_PATH` описывает путь для расположения домена при установке пакета. `LOCALE_PATH` описывает расположение домена для местной сборки программы (**без** сборки пакета).

Для генерации шаблона перевода (`pot` — `po template`) используется утилита `xgettext`, которой указывается название функции-обёртки, входной и выходной файлы: `xgettext -k_ -c src/sheepcounter.c -o po/sheepcounter.pot`.

`@user`: `sheepcounter-pkg/po/sheepcounter.pot`

```sh
# SOME DESCRIPTIVE TITLE.
# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
# This file is distributed under the same license as the PACKAGE package.
# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
#
#, fuzzy
msgid ""
msgstr ""
"Project-Id-Version: PACKAGE VERSION\n"
"Report-Msgid-Bugs-To: \n"
"POT-Creation-Date: 2025-07-24 17:22+0300\n"
"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
"Language-Team: LANGUAGE <LL@li.org>\n"
"Language: \n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=CHARSET\n"
"Content-Transfer-Encoding: 8bit\n"
"Plural-Forms: nplurals=INTEGER; plural=EXPRESSION;\n"

#. Simple text
#: src/sheepcounter.c:19
msgid "Let's count sheeps together!\n"
msgstr ""

#: src/sheepcounter.c:20
msgid "How many sheeps do you want to count? "
msgstr ""

#: src/sheepcounter.c:26
msgid "Oh, I know only digits, not numbers, try again: "
msgstr ""

#. Plural example
#: src/sheepcounter.c:33
#, c-format
msgid "We counted %d sheep\n"
msgid_plural "We counted %d sheeps\n"
msgstr[0] ""
msgstr[1] ""
```

Шаблон содержит все элементы, требующие локализации. Для создания генератора перевода используется функция `msginit` с указанием локали: `msginit -i po/sheepcounter.pot -o po/sheepcounter.po -l ru_RU.UTF-8`. При наличии уже написанного генератора (например, при внесении каких-то изменений в исходный код программы, требующих дополнительной локализации) новый шаблон объединяется со старым генератором с помощью `msgmerge`: `msgmerge -U po/sheepcounter.po po/sheepcounter.pot`.

Генератор перевода содержит мета-данные о конкретном переводе в описанном домене на описанном языке (например, указывается тернарный оператор для выбора множественной словоформы, поскольку в русском их не две, как в английском, а три). Затем он вручную заполняется разработчиком:

`@user`: `sheepcounter-pkg/po/sheepcounter.po`

```sh
# Russian translations for PACKAGE package
# Английские переводы для пакета PACKAGE.
# Copyright (C) 2025 THE PACKAGE'S COPYRIGHT HOLDER
# This file is distributed under the same license as the PACKAGE package.
#  <user@usamg1tvm>, 2025.
#
msgid ""
msgstr ""
"Project-Id-Version: PACKAGE VERSION\n"
"Report-Msgid-Bugs-To: \n"
"POT-Creation-Date: 2025-07-24 17:22+0300\n"
"PO-Revision-Date: 2025-07-24 17:34+0300\n"
"Last-Translator:  <user@usamg1tvm>\n"
"Language-Team: Russian <gnu@d07.ru>\n"
"Language: ru\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=UTF-8\n"
"Content-Transfer-Encoding: 8bit\n"
"Plural-Forms: nplurals=3; plural=(n%10==1 && n%100!=11 ? 0 : n%10>=2 && n"
"%10<=4 && (n%100<10 || n%100>=20) ? 1 : 2);\n"

#. Simple text
#: src/sheepcounter.c:19
msgid "Let's count sheeps together!\n"
msgstr "Давай считать овец вместе!\n"

#: src/sheepcounter.c:20
msgid "How many sheeps do you want to count? "
msgstr "Сколько овец ты хочешь посчитать? "

#: src/sheepcounter.c:26
msgid "Oh, I know only digits, not numbers, try again: "
msgstr "Оу, я знаю только цифры, не числа, напиши что-то другое: "

#. Plural example
#: src/sheepcounter.c:33
#, c-format
msgid "We counted %d sheep\n"
msgid_plural "We counted %d sheeps\n"
msgstr[0] "Мы посчитали %d овцу\n"
msgstr[1] "Мы посчитали %d овцы\n"
msgstr[2] "Мы посчитали %d овец\n"
~
```

Для генерации файла перевода используется функция `msgfmt`. Предварительно необходимо создать и указать поддиректории для расположения файла перевода.

```sh
mkdir -p ru/LC_MESSAGES/
msgfmt po/sheepcounter.po -o ru/LC_MESSAGES/sheepcounter.mo
```

Дополним код файлами `autotools` и проверим его работу локально (для этого необходимо использовать `bindtextdomain` с `LOCALE_PATH`):

`@user`: `sheepcounter-pkg/configure.ac`

```sh
#                                               -*- Autoconf -*-
# Process this file with autoconf to produce a configure script.


AC_INIT([sheepcounter-pkg], [1.0], [UsamG1t])
AM_INIT_AUTOMAKE([foreign subdir objects])
AM_GNU_GETTEXT(external)
AC_CONFIG_SRCDIR([src/sheepcounter.c])
AC_CONFIG_HEADERS([config.h])

# Checks for programs.
AC_PROG_CC
IT_PROG_INTLTOOL

# Checks for libraries.

# Checks for header files.
AC_CHECK_HEADERS([libintl.h])

# Optional clues
AC_ARG_ENABLE([numbers],
       AS_HELP_STRING([--enable-numbers],[Enable not only digits counting]),
       AS_IF([test "$enable_numbers" = "yes"],
              AC_DEFINE(NUMBERS, [], [Numbers counting acception]))
)

# Checks for typedefs, structures, and compiler characteristics.

# Checks for library functions.
AC_CHECK_FUNCS([setlocale])
AC_FUNC_ERROR_AT_LINE

AC_CONFIG_FILES([Makefile po/Makefile src/Makefile])
AC_OUTPUT
```

 + В настройки программы также добавлен параметр для работы с числами, а не только с цифрами. Отслеживается он с помощью ключей `--{enable/disable}-numbers`. Ключи присваивают значения `yes` или `no` макросу соответственно, в зависимости от значения производится его определение.

Опишем `make`-генераторы, при этом воспользуемся указанием поддиректорий для разделения управления компиляцией и генерации переводов.

`@user`: `sheepcounter-pkg/Makefile.am`

```make
SUBDIRS = src po
```

`@user`: `sheepcounter-pkg/src/Makefile.am`

```make
CFLAGS = -Wall -O0 -g

bin_PROGRAMS=sheepcounter
```

`@user`: `sheepcounter-pkg/po/Makefile.am`

```make
RU = ru/LC_MESSAGES
PACKAGE = sheepcounter

pkgdatadir = $(datadir)/$(PACKAGE)/ru/LC_MESSAGES

pkgdata_DATA = $(RU)/$(PACKAGE).mo

$(RU)/$(PACKAGE).mo: $(PACKAGE).po
       mkdir -p `dirname $@`
       msgfmt $< -o $@

$(PACKAGE).pot: ../src/$(PACKAGE).c
       xgettext -k_ -c $< -o $@

$(PACKAGE).po:  $(PACKAGE).pot
       msgmerge -U $@ $<
```

***ALARM:*** Возможно, костыль с `pkgdatadir`

```console
.
├── configure.ac
├── Makefile.am
├── po
│   ├── Makefile.am
│   └── sheepcounter.po
├── ru
│   └── LC_MESSAGES
│       └── sheepcounter.mo
└── src
   ├── Makefile.am
   └── sheepcounter.c
```

Соберём программу локально и проверим работоспособность (Язык в системе из примера установлен русский по умолчанию).

`@user`
```console
[user@VM sheepcounter-pkg]$ autoreconf -fisv
<...>
[user@VM sheepcounter-pkg]$ ./configure
<...>
[user@VM sheepcounter-pkg]$ make
<...>
[user@VM sheepcounter-pkg]$ src/sheepcounter
Давай считать овец вместе!

Сколько овец ты хочешь посчитать?
5
Мы посчитали 1 овцу
Мы посчитали 2 овцы
Мы посчитали 3 овцы
Мы посчитали 4 овцы
Мы посчитали 5 овец
[user@VM sheepcounter-pkg]$ LC_ALL=en_US.UTF-8 src/sheepcounter
Let's count sheeps together!

How many sheeps do you want to count?
13
Oh, I know only digits, not numbers, try again:
3
We counted 1 sheep
We counted 2 sheeps
We counted 3 sheeps
```

`@user`
```console
[user@VM sheepcounter-pkg]$ ./configure --enable-numbers
<...>
[user@VM sheepcounter-pkg]$ make
<...>
[user@VM sheepcounter-pkg]$ LC_ALL=en_US.UTF-8 src/sheepcounter
Let's count sheeps together!

How many sheeps do you want to count?
3
We counted 1 sheep
We counted 2 sheeps
We counted 3 sheeps
[user@VM sheepcounter-pkg]$ src/sheepcounter
Давай считать овец вместе!

Сколько овец ты хочешь посчитать?
21
Мы посчитали 1 овцу
Мы посчитали 2 овцы
Мы посчитали 3 овцы
Мы посчитали 4 овцы
Мы посчитали 5 овец
Мы посчитали 6 овец
Мы посчитали 7 овец
Мы посчитали 8 овец
Мы посчитали 9 овец
Мы посчитали 10 овец
Мы посчитали 11 овец
Мы посчитали 12 овец
Мы посчитали 13 овец
Мы посчитали 14 овец
Мы посчитали 15 овец
Мы посчитали 16 овец
Мы посчитали 17 овец
Мы посчитали 18 овец
Мы посчитали 19 овец
Мы посчитали 20 овец
Мы посчитали 21 овцу
[user@VM sheepcounter-pkg]$
```

Добавим `spec`-файл и соберём пакет.

`@user`: `sheepcounter-pkg/sheepcounter-pkg.spec`

```spec
%def_disable numbers

Name: sheepcounter-pkg
Version: 1.0
Release: alt1

Summary: Test pkg with i18n

License: GPLv3+
Group: Development/Other

Source0: %name-%version.tar.gz

%description
This is a small testing package, builded with i18n

%prep
%setup

%build
%autoreconf
%configure %{subst_enable numbers}
%make_build

%install
%makeinstall_std

%files
%_bindir/*

%changelog
* Thu Jul 24 2025 UsamG1t <usamg1t@altlinux.org> 1.0-alt1
- Initial build
```

`@user`
```console
[user@VM sheepcounter-pkg]$ gear-hsh
<...>
Wrote: /usr/src/RPM/SRPMS/sheepcounter-pkg-1.0-alt1.src.rpm (w2.lzdio)
Wrote: /usr/src/RPM/RPMS/x86_64/sheepcounter-pkg-1.0-alt1.x86_64.rpm (w2.lzdio)
Wrote: /usr/src/RPM/RPMS/x86_64/sheepcounter-pkg-debuginfo-1.0-alt1.x86_64.rpm (w2.lzdio)
7.19user 6.44system 0:16.74elapsed 81%CPU (0avgtext+0avgdata 21944maxresident)k
0inputs+11040outputs (0major+507403minor)pagefaults 0swaps
[user@VM sheepcounter-pkg]$ cd
```

Проверим его работу, после пересоберём с указанием параметра и вновь проверим работу (Язык в `hasher` из примера установлен английский по умолчанию):

`@user`
```console
[user@VM ~]$ hypersh hasher/repo/SRPMS.hasher/sheepcounter-pkg-1.0-alt1.src.rpm
<...>
Wrote: /usr/src/in/nosrpm/sheepcounter-pkg-1.0-alt1.nosrc.rpm (w1.gzdio)
<...>
[user@VM ~]$ cp hasher/repo/x86_64/RPMS.hasher/sheepcounter-pkg-1.0-alt1.x86_64.rpm hasher/chroot/.in/
[user@VM ~]$ hsh-shell --rooter
```

`@rooter`
```
[root@localhost .in]# rpm -i sheepcounter-pkg-1.0-alt1.x86_64.rpm
<13>Jul 28 20:23:47 rpm: sheepcounter-pkg-1.0-alt1 1753733546 installed
                                                                      [root@localhost .in]#
[root@localhost .in]# sheepcounter
Let's count sheeps together!

How many sheeps do you want to count?
30
Oh, I know only digits, not numbers, try again:
3
We counted 1 sheep
We counted 2 sheeps
We counted 3 sheeps
[root@localhost .in]# LC_ALL=ru_RU.UTF-8 sheepcounter
Давай считать овец вместе!

Сколько овец ты хочешь посчитать?
10
Оу, я знаю только цифры, не числа, напиши что-то другое:
5
Мы посчитали 1 овцу
Мы посчитали 2 овцы
Мы посчитали 3 овцы
Мы посчитали 4 овцы
Мы посчитали 5 овец
[root@localhost .in]#
```

`@builder`
```console
[builder@localhost ~]$ tree -A
.
├── RPM
│   ├── BUILD
│   ├── RPMS
│   │   └── noarch
│   ├── SOURCES
│   │   └── sheepcounter-pkg-1.0.tar.gz
│   ├── SPECS
│   │   └── sheepcounter-pkg.spec
│   └── SRPMS
├── debug
├── in
│   ├── SOURCE_DATE_EPOCH
│   ├── nosrpm
│   │   └── sheepcounter-pkg-1.0-alt1.nosrc.rpm
│   └── srpm
│       └── sheepcounter-pkg-1.0-alt1.src.rpm
└── tmp

13 directories, 5 files
[builder@localhost ~]$ rpmbuild -ba -enable=numbers RPM/SPECS/sheepcounter-pkg.spec
<...>
+ ./configure --build=x86_64-alt-linux --host=x86_64-alt-linux --prefix=/usr --exec-prefix=/usr --bindir=/usr/bin --sbindir=/usr/sbin --sysconfdir=/etc --datadir=/usr/share --includedir=/usr/include --libdir=/usr/lib64 --libexecdir=/usr/lib --localstatedir=/var/lib --sharedstatedir=/var/lib --mandir=/usr/share/man --infodir=/usr/share/info --disable-dependency-tracking --disable-silent-rules --runstatedir=/var/run --without-included-gettext --enable-numbers
<...>
Wrote: /usr/src/RPM/SRPMS/sheepcounter-pkg-1.0-alt1.src.rpm (w2.lzdio)
Wrote: /usr/src/RPM/RPMS/x86_64/sheepcounter-pkg-1.0-alt1.x86_64.rpm (w2.lzdio)
Wrote: /usr/src/RPM/RPMS/x86_64/sheepcounter-pkg-debuginfo-1.0-alt1.x86_64.rpm (w2.lzdio)
[builder@localhost ~]$
```

`@rooter`
```console
[root@localhost .in]# rpm -i --replacefiles /usr/src/RPM/RPMS/x86_64/sheepcounter-pkg-1.0-alt1.x86_64.rpm
<13>Jul 28 20:31:42 rpm: sheepcounter-pkg-1.0-alt1 1753734599 installed
                                                                      [root@localhost .in]#
[root@localhost .in]# sheepcounter
Let's count sheeps together!

How many sheeps do you want to count?
10
We counted 1 sheep
We counted 2 sheeps
We counted 3 sheeps
We counted 4 sheeps
We counted 5 sheeps
We counted 6 sheeps
We counted 7 sheeps
We counted 8 sheeps
We counted 9 sheeps
We counted 10 sheeps
[root@localhost .in]# LC_MESSAGES=ru_RU.UTF-8 sheepcounter
Давай считать овец вместе!

Сколько овец ты хочешь посчитать?
21
Мы посчитали 1 овцу
Мы посчитали 2 овцы
Мы посчитали 3 овцы
Мы посчитали 4 овцы
Мы посчитали 5 овец
Мы посчитали 6 овец
Мы посчитали 7 овец
Мы посчитали 8 овец
Мы посчитали 9 овец
Мы посчитали 10 овец
Мы посчитали 11 овец
Мы посчитали 12 овец
Мы посчитали 13 овец
Мы посчитали 14 овец
Мы посчитали 15 овец
Мы посчитали 16 овец
Мы посчитали 17 овец
Мы посчитали 18 овец
Мы посчитали 19 овец
Мы посчитали 20 овец
Мы посчитали 21 овцу
[root@localhost .in]#
```